#!/bin/bash
set -euo pipefail

#Initialize necessary directories and variables
function init_vars() {
    mkdir -p deployment-configs
}

function generate_deployment_files() {
    local tenant="${1:-default-tenant}"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local deployment_file="deployment-configs/${tenant}-deployment.txt"

    echo "Generating deployment YAML for tenant: $tenant"

    #
    echo "Deployment File for ${tenant}" > "${deployment_file}"
    echo "Timestamp: ${timestamp}" >> "${deployment_file}"
    echo "Status: CONFIG_GENERATED" >> "${deployment_file}"

    echo "[INFO] Deployment file generated at ${deployment_file}"

    # Create simple JSON summary
    local summary_file="deployment-configs/${tenant}-summary.json"
    cat > "${summary_file}" <<EOF
{
    "tenant": "${tenant}",
    "deployment_file": "${deployment_file}",
    "timestamp": "${timestamp}",
    "status": "CONFIG_GENERATED"
}
EOF

    echo "[INFO] Summary file generated at ${summary_file}"
}

# Display deployment information
function display_deployment_info() {
    local tenant="${1:-default-tenant}"
    echo ""
    echo "Deployment configuration generation completed."
    echo "Generated files"
    echo "- deployment-configs/${tenant}-deployment.txt"
    echo "- deployment-configs/${tenant}-summary.json"
    echo ""
}

# Main execution flow
function main() {
    init_vars
    echo "[INFO] Starting deployment configuration generation..."

    local pipeline_file="tenant-deployment-pipeline.yml"
    if [[ ! -f "$pipeline_file" ]]; then
        echo "[WARN] Pipeline file not found. Using default tenant."
        local tenant="${TENANT_NAME:-sample-tenant}"
        generate_deployment_files "$tenant"
        display_deployment_info "$tenant"
        exit 0
    fi

    # Parse pipeline and deploy for each tenant
    local tenants=$(grep "^deploy-" "$pipeline_file" | sed 's/deploy-//' | sed 's/:$//')
    for tenant in $tenants; do
        echo "[INFO] Deploying for tenant: $tenant"

        # Extract variables for this tenant
        local env_var=$(grep -A 10 "deploy-$tenant:" "$pipeline_file" | grep "ENVIRONMENT:" | cut -d'"' -f2)
        local tenant_id=$(grep -A 10 "deploy-$tenant:" "$pipeline_file" | grep "TENANT_ID:" | cut -d'"' -f2)
        local custom_setting=$(grep -A 10 "deploy-$tenant:" "$pipeline_file" | grep "CUSTOM_SETTING:" | cut -d'"' -f2)

        # Set variables and generate
        TENANT_NAME="$tenant" ENVIRONMENT="$env_var" TENANT_ID="$tenant_id" CUSTOM_SETTING="$custom_setting" generate_deployment_files "$tenant"
        display_deployment_info "$tenant"
    done

    exit 0
}

main