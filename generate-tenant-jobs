#!/bin/bash

# This script wil create simple pipeline configuration by iteration over manifest files.
output_file="tenant-deployment-pipeline.yml"

# Start with a fresth output file
echo "# Generated Deployment Pipeline" > "$output_file"

detect_config_changes() {
    local changed_file=$(git diff-tree --name-only --no-commit-id -r $GITHUB_SHA)
    if echo "$changed_file" | grep -q '^tenant-specific-overrides/'; then
        local tenants=$(echo "$changed_file" | grep '^tenant-specific-overrides/' | cut -d'/' -f2 | sort -u | tr '\n' ',')
        tenants=${tenants%,}  # Remove trailing comma
        echo "[INFO] Detected changes in tenant-specific overrides for tenants: $tenants" >&2
        echo "$tenants"
        return 0
    else
        return 1
    fi
}

if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
    if affected_tenants=$(detect_config_changes); then
        echo "[INFO] Generating jobs only for affected tenants: ${affected_tenants}" >&2
    else
        echo "[INFO] No changes detected in tenant-specific overrides. Exiting job generation." >&2
        exit 0
    fi
fi

# Iterate over all manifest files
for manifest_file in manifests/*.yaml; do
    echo "$manifest_file"
    tenant_name=$(basename "$manifest_file" .yaml)
    
    echo "Adding deployment job for tenant: $tenant_name"

    if [[ "$tenant_name" == "default-manifest" ]]; then
        echo "[INFO] Skipped $tenant_name manifest file."
        continue
    fi

    echo "[INFO] Generating job for tenant: $tenant_name"

    config_path="tenant-specific-overrides/$tenant_name/$tenant_name-config.yaml"
    if [[ ! -f "$config_path" ]]; then
        echo "[WARN] Config not found for $tenant_name at $config_path. Skipping..."
        continue
    fi

    # Extract variables from config (simple grep for demo)
    env_var=$(grep "ENVIRONMENT:" "$config_path" | cut -d':' -f2 | tr -d ' ' | sed 's/"//g')
    tenant_id=$(grep "TENANT_ID:" "$config_path" | cut -d':' -f2 | tr -d ' ' | sed 's/"//g')
    custom_setting=$(grep "CUSTOM_SETTING:" "$config_path" | cut -d':' -f2 | tr -d ' ' | sed 's/"//g')

    cat >> "$output_file" <<EOF

# Deployment Job for $tenant_name
deploy-${tenant_name}:
    stage: deploy
    script:
        - ./deploy
    variables:
        INPUT_MANIFEST: "manifests/default-manifest.yaml"
        TENANT_NAME: "$tenant_name"
        ENVIRONMENT: "$env_var"
        TENANT_ID: "$tenant_id"
        CUSTOM_SETTING: "$custom_setting"
EOF
    echo "[INFO] Job for $tenant_name added successfully."
done
